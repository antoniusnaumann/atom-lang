+String(
    bytes UInt(8)*
)

+len(s String) Int {
    s.cstring::strlen()
}

// Determine UTF-8 sequence length from first byte
// Returns: 1 for ASCII, 2-4 for multibyte, 0 for invalid
-utf8_len(b UInt(8)) Int {
    match(((b & 0b10000000) == 0)) {
        True { 1 }
        False {
            match(((b & 0b11100000) == 0b11000000)) {
                True { 2 }
                False {
                    match(((b & 0b11110000) == 0b11100000)) {
                        True { 3 }
                        False {
                            match(((b & 0b11111000) == 0b11110000)) {
                                True { 4 }
                                False { 0 }
                            }
                        }
                    }
                }
            }
        }
    }
}

+runes(s String) Rune* {
    result: Rune*
    i := 0
    byte_len := s.bytes.len()
    
    loop(i < byte_len) {
        b := s.bytes(i)
        seq_len := utf8_len(b)
        
        rune := match(seq_len) {
            1 {
                i += 1
                b
            }
            2 {
                match((i + 1) < byte_len) {
                    True {
                        r := (((b & 0b00011111) << 6) | (s.bytes(i + 1) & 0b00111111))
                        i += 2
                        r
                    }
                    False {
                        i += 1
                        0xFFFD
                    }
                }
            }
            3 {
                match((i + 2) < byte_len) {
                    True {
                        r := (((b & 0b00001111) << 12) | ((s.bytes(i + 1) & 0b00111111) << 6) | (s.bytes(i + 2) & 0b00111111))
                        i += 3
                        r
                    }
                    False {
                        i += 1
                        0xFFFD
                    }
                }
            }
            4 {
                match((i + 3) < byte_len) {
                    True {
                        r := (((b & 0b00000111) << 18) | ((s.bytes(i + 1) & 0b00111111) << 12) | ((s.bytes(i + 2) & 0b00111111) << 6) | (s.bytes(i + 3) & 0b00111111))
                        i += 4
                        r
                    }
                    False {
                        i += 1
                        0xFFFD
                    }
                }
            }
            _ {
                // Invalid UTF-8 sequence
                i += 1
                0xFFFD
            }
        }
        
        result ++= rune
    }
    
    result
}

